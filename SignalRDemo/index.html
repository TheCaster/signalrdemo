<!DOCTYPE html>
<html>
<head>
    <title>NFleet SignalR Demo</title>
    <style type="text/css">
        #map {
            height: 1000px;
        }
    </style>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
</head>
<body>
    <div id="map"></div>

    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <script src="Scripts/jquery.signalR-2.1.0.min.js"></script>
    <script src="signalr/hubs"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script type="text/javascript">
        $(function () {

            var map = L.map('map').setView([62.25, 25.75], 13);
            var moveMarkerHub = $.connection.markerHub;
            var markers = {};

            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org">OpenStreetMap</a> contributors.',
                maxZoom: 18
            }).addTo(map);

            map.doubleClickZoom.disable();

            map.on('click', function (e) {
                moveMarkerHub.server.updateModel(
                {
                    id: Math.floor((Math.random() * 100000) + 1),
                    latitude: e.latlng.lat,
                    longitude: e.latlng.lng
                });
            });

            $.connection.hub.start().done(function () {
                moveMarkerHub.server.requestUpdate();
            });

            moveMarkerHub.client.updateMarker = function (model) {

                for (var i = 0; i < model.length; i++) {
                    if (markers[model[i].id] == undefined) {
                        markers[model[i].id] = L.marker([0, 0], { draggable: true });
                        markers[model[i].id].addTo(map);
                        markers[model[i].id].on('dragend', function (e) {

                            moveMarkerHub.server.updateModel(
                            {
                                id: e.target.id,
                                latitude: e.target._latlng.lat,
                                longitude: e.target._latlng.lng
                            });

                        });
                        markers[model[i].id].on('contextmenu', function (e) {

                            moveMarkerHub.server.delete(
                            {
                                id: e.target.id,
                            });

                        });
                    }
                    markers[model[i].id].setLatLng(L.latLng([model[i].latitude, model[i].longitude]));
                    markers[model[i].id].id = model[i].id;
                }
            };



        });
    </script>

</body>
</html>